<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Motor Wars 2 Original | Players</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Motor Wars 2 Original</h2>

    <div class="category">
      <h3>Search & Analyze</h3>

      <!-- DO NOT CHANGE -->
      <button class="side-btn active" id="btnAllPlayers">Players</button>

      <!-- ADDED -->
      <button class="side-btn sub" id="btnActivePlayers">Active Players</button>

      <button class="side-btn">Clans</button>
    </div>

    <div class="category">
      <h3>Scores & Ranking</h3>
      <button class="side-btn">Nostalgia Night</button>
    </div>

    <div class="category">
      <h3>Analytics</h3>
      <button class="side-btn">Statistics</button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- Search bar -->
    <div class="top-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search for a player..."
      />
      <button class="search-btn" id="btnSearchPlayer">Search Player</button>
    </div>

    <!-- Player Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Country</th>
            <th>Player</th>
            <th>Xp</th>
            <th>Join Date</th>
            <th>Last Online</th>
            <th>Clan</th>
          </tr>
        </thead>
        <tbody id="playerTableBody">
          <tr><td colspan="7">Loading players...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<script>
  const API_URL = 'https://mainserver.serv00.net/API/players.php';

  let cachedPlayers = [];
  let showActiveOnly = false;
  let searchQuery = '';

  const btnAll = document.getElementById('btnAllPlayers');
  const btnActive = document.getElementById('btnActivePlayers');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('btnSearchPlayer');

  // Convert country code (US) to flag emoji üá∫üá∏
  function countryCodeToFlagEmoji(code) {
    if (!code) return '';
    return code
      .toUpperCase()
      .split('')
      .map(c => String.fromCodePoint(127397 + c.charCodeAt()))
      .join('');
  }

  function mapPlayerData(player) {
    return {
      country: player.country || 'N/A',
      countryFlag: player.country ? countryCodeToFlagEmoji(player.country) : 'üè≥Ô∏è',
      username: player.nickname || 'Unknown',
      xp: Number(player.honor_points) || 0,
      join_date: player.registration_date || 'N/A',
      last_online: player.last_login || 'N/A',
      clan: player.clan || '-'
    };
  }

  function renderPlayers(players) {
    const tbody = document.getElementById('playerTableBody');
    tbody.innerHTML = '';

    if (players.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">No players found.</td></tr>';
      return;
    }

    players.forEach((playerRaw, index) => {
      const player = mapPlayerData(playerRaw);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${player.countryFlag}</td>
        <td>${player.username}</td>
        <td>${player.xp}</td>
        <td>${player.join_date}</td>
        <td>${player.last_online}</td>
        <td>${player.clan}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function applyFilter() {
    let players = [...cachedPlayers];

    // Active Players filter (last 30 days)
    if (showActiveOnly) {
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      players = players.filter(p => {
        if (!p.last_login) return false;
        const lastLoginDate = new Date(p.last_login);
        return lastLoginDate >= thirtyDaysAgo;
      });
    }

    // Search filter (starts with)
    if (searchQuery.length > 0) {
      const q = searchQuery.toLowerCase();
      players = players.filter(p =>
        (p.nickname || '').toLowerCase().startsWith(q)
      );
    }

    // Sort by XP (highest first)
    players.sort((a, b) => {
      const xpA = Number(a.honor_points) || 0;
      const xpB = Number(b.honor_points) || 0;
      return xpB - xpA;
    });

    renderPlayers(players);
  }

  async function loadPlayers() {
    try {
      const response = await fetch(API_URL);
      cachedPlayers = await response.json();
      applyFilter();
    } catch (err) {
      console.error(err);
      document.getElementById('playerTableBody').innerHTML =
        '<tr><td colspan="7">Failed to load player data.</td></tr>';
    }
  }

  // Button handlers
  btnAll.addEventListener('click', () => {
    showActiveOnly = false;
    btnAll.classList.add('active');
    btnActive.classList.remove('active');
    applyFilter();
  });

  btnActive.addEventListener('click', () => {
    showActiveOnly = true;
    btnActive.classList.add('active');
    btnAll.classList.remove('active');
    applyFilter();
  });

  // Search handlers
  searchBtn.addEventListener('click', () => {
    searchQuery = searchInput.value.trim();
    applyFilter();
  });

  searchInput.addEventListener('input', () => {
    searchQuery = searchInput.value.trim();
    applyFilter();
  });

  window.addEventListener('DOMContentLoaded', loadPlayers);
</script>

</body>
</html>
