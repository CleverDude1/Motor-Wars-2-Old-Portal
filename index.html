<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Motor Wars 2 Original | Players</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    th { cursor: pointer; }
  </style>
</head>
<body>

<div class="container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Motor Wars 2 Original</h2>

    <div class="category">
      <h3>Search & Analyze</h3>

      <!-- DO NOT CHANGE -->
      <button class="side-btn active" id="btnAllPlayers">Players</button>

      <!-- ADDED -->
      <button class="side-btn sub" id="btnActivePlayers">Active Players</button>

      <button class="side-btn">Clans</button>
    </div>

    <div class="category">
      <h3>Scores & Ranking</h3>
      <button class="side-btn">Nostalgia Night</button>
    </div>

   <div class="category">
  <h3>Analytics</h3>
  <button class="side-btn">Statistics</button>
  <!-- New XP Calculator Button -->
  <button class="side-btn" id="btnXpCalculator" onclick="window.location.href='xp_calculator.html'">XP Calculator</button>
</div>


  <!-- Main Content -->
  <main class="main">

    <!-- Search bar -->
    <div class="top-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search for a player..."
      />
      <button class="search-btn" id="btnSearchPlayer">Search Player</button>
    </div>

    <!-- Player Table -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th data-sort="index">#</th>
            <th data-sort="country">Country</th>
            <th data-sort="username">Player</th>
            <th data-sort="xp">Xp</th>
            <th data-sort="join_date">Join Date</th>
            <th data-sort="last_online">Last Online</th>
            <th data-sort="clan">Clan</th>
          </tr>
        </thead>
        <tbody id="playerTableBody">
          <tr><td colspan="7">Loading players...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<script>
  const API_URL = 'https://mainserver.serv00.net/API/players.php';

  let cachedPlayers = [];
  let showActiveOnly = false;
  let searchQuery = '';
  let sortField = 'index';
  let sortAsc = true;

  const btnAll = document.getElementById('btnAllPlayers');
  const btnActive = document.getElementById('btnActivePlayers');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('btnSearchPlayer');
  const headers = document.querySelectorAll('th[data-sort]');

  function mapPlayerData(player) {
    return {
      index: 0, // placeholder, will use array index
      country: player.country || 'N/A',
      username: player.nickname || 'Unknown',
      xp: Number(player.honor_points) || 0,
      join_date: player.registration_date || 'N/A',
      last_online: player.last_login || 'N/A',
      clan: player.clan || '-'
    };
  }

  function renderPlayers(players) {
    const tbody = document.getElementById('playerTableBody');
    tbody.innerHTML = '';

    if (players.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">No players found.</td></tr>';
      return;
    }

    players.forEach((playerRaw, index) => {
      const player = mapPlayerData(playerRaw);
      player.index = index + 1;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${player.index}</td>
        <td>${player.country}</td>
        <td>${player.username}</td>
        <td>${player.xp}</td>
        <td>${player.join_date}</td>
        <td>${player.last_online}</td>
        <td>${player.clan}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function applyFilter() {
    let players = [...cachedPlayers];

    // Active Players filter (last 30 days)
    if (showActiveOnly) {
      const now = new Date();
      const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

      players = players.filter(p => {
        if (!p.last_login) return false;
        const lastLoginDate = new Date(p.last_login);
        return lastLoginDate >= thirtyDaysAgo;
      });
    }

    // Search filter (starts with)
    if (searchQuery.length > 0) {
      const q = searchQuery.toLowerCase();
      players = players.filter(p =>
        (p.nickname || '').toLowerCase().startsWith(q)
      );
    }

    // Sort
    players.sort((a, b) => {
      let valA, valB;

      switch (sortField) {
        case 'index':
          valA = cachedPlayers.indexOf(a);
          valB = cachedPlayers.indexOf(b);
          break;
        case 'country':
          valA = a.country || '';
          valB = b.country || '';
          break;
        case 'username':
          valA = a.nickname || '';
          valB = b.nickname || '';
          break;
        case 'xp':
          valA = Number(a.honor_points) || 0;
          valB = Number(b.honor_points) || 0;
          break;
        case 'join_date':
          valA = new Date(a.registration_date || 0);
          valB = new Date(b.registration_date || 0);
          break;
        case 'last_online':
          valA = new Date(a.last_login || 0);
          valB = new Date(b.last_login || 0);
          break;
        case 'clan':
          valA = a.clan || '';
          valB = b.clan || '';
          break;
        default:
          valA = 0; valB = 0;
      }

      if (valA < valB) return sortAsc ? -1 : 1;
      if (valA > valB) return sortAsc ? 1 : -1;
      return 0;
    });

    renderPlayers(players);
  }

  async function loadPlayers() {
    try {
      const response = await fetch(API_URL);
      cachedPlayers = await response.json();
      applyFilter();
    } catch (err) {
      console.error(err);
      document.getElementById('playerTableBody').innerHTML =
        '<tr><td colspan="7">Failed to load player data.</td></tr>';
    }
  }

  // Header click sorting
  headers.forEach(th => {
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-sort');
      if (sortField === field) {
        sortAsc = !sortAsc; // toggle
      } else {
        sortField = field;
        sortAsc = true;
      }
      applyFilter();
    });
  });

  // Button handlers
  btnAll.addEventListener('click', () => {
    showActiveOnly = false;
    btnAll.classList.add('active');
    btnActive.classList.remove('active');
    applyFilter();
  });

  btnActive.addEventListener('click', () => {
    showActiveOnly = true;
    btnActive.classList.add('active');
    btnAll.classList.remove('active');
    applyFilter();
  });

  // Search handlers
  searchBtn.addEventListener('click', () => {
    searchQuery = searchInput.value.trim();
    applyFilter();
  });

  searchInput.addEventListener('input', () => {
    searchQuery = searchInput.value.trim();
    applyFilter();
  });

  window.addEventListener('DOMContentLoaded', loadPlayers);
</script>

</body>
</html>
